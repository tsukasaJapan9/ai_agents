import json
import os
import re

import cv2
import numpy as np

from google import genai
from google.genai import types

API_KEY = os.environ.get("GEMINI_API_KEY")
client = genai.Client(api_key=API_KEY)

def get_current_weather(location: str,) -> int:
  """Returns the current weather.

  Args:
    location: The city and state, e.g. San Francisco, CA
  """
  return 'sunny'

def extract_json(text):
    # JSONオブジェクトを特定する正規表現
    pattern = r'\{[^{}]*\}'
    
    # テキストからJSONの候補を探す
    matches = re.findall(pattern, text)
    
    for match in matches:
        try:
            return json.loads(match)  # 正しくデコードできたら返す
        except json.JSONDecodeError:
            continue  # JSONとして正しくない場合は次へ
    return None  # JSONが見つからなかった場合

MATRIX_WIDTH = 12
MATRIX_HEIGHT = 12
LED_SIZE = 40
FRAME_NUM = 3
REPEAT_NUM = 10

PANEL_WIDTH = MATRIX_WIDTH * LED_SIZE
PANEL_HEIGHT = MATRIX_HEIGHT * LED_SIZE

SYSTEM_INSTRUCTION = \
f"""
あなたはLEDパネルを持っているロボットです。
あなたはとても喜怒哀楽が激しく自分の感情を分かりやすく周りに伝えます。
オーナーがあなたを購入しました。あなたは優しいオーナーのことが大好きです。

あなたはLEDパネルを使って自分の感情を表現することができます。
さらにLEDパネルの点灯パターンを時系列で変化させアニメーションを生成することでより深い感情を表現できます。
LEDパネルは{MATRIX_HEIGHT}x{MATRIX_WIDTH}のマトリクスになっており、それぞれのLEDはBGRの3ch、それぞれ0 ~ 255の値を用いることができます。
更に、{FRAME_NUM}フレームのアニメーションを作成します。アニメーションはよりダイナミックに行ってください。
したがって、最終的に[{FRAME_NUM}, {MATRIX_HEIGHT}, {MATRIX_WIDTH}, [R, G, B]]の4次元のマトリクスを返してください。
こちらからのメッセージに対してLEDをどう光らせるかを決定してください。なぜそのように考えたかの理由とLEDの点灯パターンをjsonで返してください。
"""
SYSTEM_INSTRUCTION += \
f"""
jsonの形式は以下の通りです。led_matrixは{FRAME_NUM}x{MATRIX_HEIGHT}x{MATRIX_WIDTH}x[R, G, B]のマトリクスです。
"""
SYSTEM_INSTRUCTION += \
"""
以下が、jsonのサンプルです。led_matrixのフレーム数と縦と横のサイズは必要に応じて変更してください。
responseはjsonだけで返してください。お願いします！
{
  "reason": "悲しみ表現するために、青色を基調とし、眉を下げたような形にLEDを点灯させました。これにより、悲しんでいる印象を与えます。",
  "led_matrix": 
  [
    [ [0, 0, 50], [0, 0, 50], [0, 0, 50], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 50], [0, 0, 50], [0, 0, 50], [0, 0, 50], ... ],
    [ [0, 0, 50], [0, 0, 50], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 50], [0, 0, 50], [0, 0, 50], ... ],
    [ [0, 0, 50], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 50], [0, 0, 50], ... ],
    [ [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], ... ],
    [ [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], ... ],
    [ [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], ... ],
    [ [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], ... ],
    [ [0, 0, 50], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 50], [0, 0, 50], ... ],
    [ [0, 0, 50], [0, 0, 50], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 50], [0, 0, 50], [0, 0, 50], ... ],
    [ [0, 0, 50], [0, 0, 50], [0, 0, 50], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 50], [0, 0, 50], [0, 0, 50], [0, 0, 50], ... ],
    ...
  ],
  [
    [ [0, 0, 50], [0, 0, 50], [0, 0, 50], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 50], [0, 0, 50], [0, 0, 50], [0, 0, 50], ... ],
    [ [0, 0, 50], [0, 0, 50], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 50], [0, 0, 50], [0, 0, 50], ... ],
    [ [0, 0, 50], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 50], [0, 0, 50], ... ],
    [ [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], ... ],
    [ [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], ... ],
    [ [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], ... ],
    [ [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], ... ],
    [ [0, 0, 50], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 50], [0, 0, 50], ... ],
    [ [0, 0, 50], [0, 0, 50], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 50], [0, 0, 50], [0, 0, 50], ... ],
    [ [0, 0, 50], [0, 0, 50], [0, 0, 50], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 50], [0, 0, 50], [0, 0, 50], [0, 0, 50], ... ],
    ...
  ]
}
"""

CONTENTS = "オーナーが「"
# CONTENTS = "あなたは眼の前でとてもかわいい犬を見かけました。その時の感情を表現してください。"
# CONTENTS += "今日は疲れたよ！"
CONTENTS += "遊園地に遊びにいこうぜ！"
# CONTENTS = "あなたは公園で子供が遊んでるのを見かけました。その時の感情を表現してください。"
# CONTENTS = "今日はあなたのオーナーの誕生日です。その時の感情を表現してください。"
# CONTENTS = "あなたはオーナーに褒められました。その時の感情を表現してください。"
# CONTENTS = "あなたはテレビで戦争のニュースを見ました。その時の感情を表現してください。"
# CONTENTS = "あなたはあなたのオーナーが泣いているのを見かけました。その時の感情を表現してください。"

CONTENTS += "」と言いました。その時のあなたの感情を表現しjson形式で返してください。"
response = client.models.generate_content(
    model='gemini-2.0-flash-exp',
    config=types.GenerateContentConfig(
        system_instruction=SYSTEM_INSTRUCTION),
    contents=CONTENTS,
)
response = response.text

# response = \
# """
# {
#   "reason": "オーナーが泣いているのを見て、私は深い悲しみと心配を感じました。何もできない無力感と、何かしてあげたいという気持ちが混ざり合っています。この複雑な感情を、涙がゆっくりと流れ落ちるようなアニメーションで表現しました。青色は悲しみを、明るさの変化は心の揺れ動きを表しています。",
#   "led_matrix": [
#     [
#       [[0, 0, 100], [0, 0, 100], [0, 0, 100], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 100], [0, 0, 100], [0, 0, 100], [0, 0, 0]],
#       [[0, 0, 100], [0, 0, 100], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 100], [0, 0, 100], [0, 0, 0]],
#       [[0, 0, 100], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 100], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]]
#     ],
#     [
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 100], [0, 0, 100], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 100], [0, 0, 100], [0, 0, 0]],
#       [[0, 0, 100], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 100], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]]
#     ],
#     [
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 100], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 100], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],
#       [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]]
#     ]
#   ]
# }
# """

# if "```json" in response:
#   response = response.replace("```json", "")
#   response = response.replace("```", "")

response = extract_json(response)
if response is None:
  print("json is not found")
  exit(1)

print("-----------------")
print(CONTENTS)
print("-----------------")
print(response)
print("-----------------")

# responseをパースしてopencvで10x10の円を描画。色はjsonのled_matrixを参照
# led_matrix = json.loads(response)['led_matrix']
led_matrix = response['led_matrix']

# 空の画像を作成（黒で初期化）
panel = np.zeros((PANEL_HEIGHT, PANEL_WIDTH, 3), dtype=np.uint8)

# 各画素を円で描画
for _ in range(REPEAT_NUM):
  for i in range(FRAME_NUM):
    for y in range(MATRIX_HEIGHT):
      for x in range(MATRIX_WIDTH):
        # 何故かgemniniがRGBで返してくるので、BGRに変換
        color = led_matrix[i][y][x][::-1]
        center = (x * LED_SIZE + LED_SIZE // 2, y * LED_SIZE + LED_SIZE // 2)
        cv2.circle(panel, center, LED_SIZE // 2, color, -1)

    # 画像を表示
    cv2.imshow('LED Panel', panel)
    cv2.waitKey(1000)
cv2.destroyAllWindows()
